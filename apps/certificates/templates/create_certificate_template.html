<!-- templates/create_certificate_template.html -->
{% extends 'partials/base.html' %}
{% load static %}

{% block title %}{% if object %}Editar{% else %}Criar{% endif %} Template de certificado - Sinapse{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Cabe√ßalho -->
        <div class="text-center mb-12">
            <div class="flex justify-center mb-4">
                <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-teal-600 rounded-2xl flex items-center justify-center">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
                {% if object %}Editar Template{% else %}Criar template de certificado{% endif %}
            </h1>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                Crie certificados personalizados para seus eventos com nosso editor intuitivo
            </p>
        </div>

        <!-- Mensagens -->
        {% if messages %}
        <div class="mb-6">
            {% for message in messages %}
            <div class="{% if message.tags == 'success' %}bg-green-50 border border-green-200 text-green-800{% else %}bg-red-50 border border-red-200 text-red-800{% endif %} rounded-lg p-4 mb-3">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        {% if message.tags == 'success' %}
                        <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        {% else %}
                        <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                        {% endif %}
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium">{{ message }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Sidebar - Controles -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-lg p-6 sticky top-8">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Configura√ß√µes</h2>
                    
                    <form method="POST" class="space-y-6">
                        {% csrf_token %}
                        
                        <!-- Exibir erros n√£o relacionados a campos espec√≠ficos -->
                        {% if form.non_field_errors %}
                        <div class="bg-red-50 border-l-4 border-red-400 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-red-700">
                                        {% for error in form.non_field_errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Nome do Template -->
                        <div>
                            <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Nome do Template *
                            </label>
                            {{ form.name }}
                            {% if form.name.errors %}
                            <div class="text-sm text-red-600 mt-2">
                                {% for error in form.name.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Dimens√µes -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="{{ form.width.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Largura (px)
                                </label>
                                {{ form.width }}
                                {% if form.width.errors %}
                                <div class="text-sm text-red-600 mt-2">
                                    {% for error in form.width.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div>
                                <label for="{{ form.height.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Altura (px)
                                </label>
                                {{ form.height }}
                                {% if form.height.errors %}
                                <div class="text-sm text-red-600 mt-2">
                                    {% for error in form.height.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Tags Dispon√≠veis -->
                        <div class="bg-blue-50 rounded-lg p-4">
                            <h3 class="font-bold text-blue-900 mb-3">Tags Dispon√≠veis</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span class="font-mono bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">first_name</span>
                                        <span class="text-blue-700 ml-2">Nome do aluno</span>
                                    </div>
                                    <button type="button" data-tag="first_name" class="tag-btn text-blue-600 hover:text-blue-800 text-xs font-medium">
                                        Inserir
                                    </button>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span class="font-mono bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">last_name</span>
                                        <span class="text-blue-700 ml-2">Sobrenome do aluno</span>
                                    </div>
                                    <button type="button" data-tag="last_name" class="tag-btn text-blue-600 hover:text-blue-800 text-xs font-medium">
                                        Inserir
                                    </button>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span class="font-mono bg-green-100 text-green-800 px-2 py-1 rounded text-xs">name</span>
                                        <span class="text-green-700 ml-2">Nome do evento</span>
                                    </div>
                                    <button type="button" data-tag="name" class="tag-btn text-green-600 hover:text-green-800 text-xs font-medium">
                                        Inserir
                                    </button>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span class="font-mono bg-green-100 text-green-800 px-2 py-1 rounded text-xs">city</span>
                                        <span class="text-green-700 ml-2">Cidade do evento</span>
                                    </div>
                                    <button type="button" data-tag="city" class="tag-btn text-green-600 hover:text-green-800 text-xs font-medium">
                                        Inserir
                                    </button>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span class="font-mono bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs">start_date</span>
                                        <span class="text-purple-700 ml-2">Data de in√≠cio</span>
                                    </div>
                                    <button type="button" data-tag="start_date" class="tag-btn text-purple-600 hover:text-purple-800 text-xs font-medium">
                                        Inserir
                                    </button>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span class="font-mono bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs">emitted_at</span>
                                        <span class="text-purple-700 ml-2">Data de emiss√£o</span>
                                    </div>
                                    <button type="button" data-tag="emitted_at" class="tag-btn text-purple-600 hover:text-purple-800 text-xs font-medium">
                                        Inserir
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Bot√µes de A√ß√£o -->
                        <div class="flex flex-col space-y-4 pt-4">
                            <button type="submit" 
                                    class="bg-gradient-to-br from-green-500 to-teal-600 text-white py-3 rounded-lg hover:from-green-600 hover:to-teal-700 transition duration-300 shadow-lg font-medium">
                                {% if object %}Atualizar Template{% else %}Criar Template{% endif %}
                            </button>
                            <a href="{% url 'certificate_template_list' %}" 
                               class="bg-gray-100 text-gray-700 py-3 rounded-lg hover:bg-gray-200 transition duration-300 text-center font-medium">
                                Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- √Årea Principal - Editor -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900">Editor de Certificado</h2>
                        <div class="flex space-x-3">
                            <button id="preview-btn" 
                                    class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-300 text-sm font-medium">
                                üëÅÔ∏è Preview
                            </button>
                            <button id="reset-btn" 
                                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition duration-300 text-sm font-medium">
                                üîÑ Resetar
                            </button>
                        </div>
                    </div>

                    <!-- Editor HTML -->
                    <div>
                        <label for="{{ form.html_content.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Conte√∫do HTML do Certificado *
                        </label>
                        {{ form.html_content }}
                        {% if form.html_content.errors %}
                        <div class="text-sm text-red-600 mt-2">
                            {% for error in form.html_content.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-2">
                            Use as tags acima para inserir informa√ß√µes din√¢micas. Clique em "Inserir" para adicionar uma tag no cursor.
                        </p>
                    </div>

                    <!-- Preview do Certificado -->
                    <div id="preview-container" class="hidden mt-8">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Preview do Certificado</h3>
                        <div class="border-2 border-gray-300 rounded-lg p-4 bg-white overflow-auto">
                            <div id="certificate-preview" class="bg-white shadow-lg mx-auto"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const htmlContent = document.getElementById('id_html_content');
    const tagButtons = document.querySelectorAll('.tag-btn');
    const previewBtn = document.getElementById('preview-btn');
    const resetBtn = document.getElementById('reset-btn');
    const previewContainer = document.getElementById('preview-container');
    const certificatePreview = document.getElementById('certificate-preview');

    // Inserir tags no editor
    tagButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tag = this.getAttribute('data-tag');
            const startPos = htmlContent.selectionStart;
            const endPos = htmlContent.selectionEnd;
            
            // Gerar literalmente {{ tag }}
            const tagText = '{{ ' + tag + ' }}';
            
            htmlContent.value = htmlContent.value.substring(0, startPos) + 
                              tagText + 
                              htmlContent.value.substring(endPos);
            
            // Reposicionar cursor
            htmlContent.selectionStart = htmlContent.selectionEnd = startPos + tagText.length;
            htmlContent.focus();
        });
    });

    // Preview do certificado
    previewBtn.addEventListener('click', function() {
        const content = htmlContent.value;
        const widthInput = document.getElementById('id_width');
        const heightInput = document.getElementById('id_height');
        const width = widthInput ? widthInput.value : '800';
        const height = heightInput ? heightInput.value : '600';
        
        // Substituir tags por valores de exemplo
        const exampleContent = content
            .replace(/\{\{\s*first_name\s*\}\}/g, 'Jo√£o')
            .replace(/\{\{\s*last_name\s*\}\}/g, 'Silva')
            .replace(/\{\{\s*name\s*\}\}/g, 'Tech Conference 2024')
            .replace(/\{\{\s*city\s*\}\}/g, 'S√£o Paulo')
            .replace(/\{\{\s*state\s*\}\}/g, 'SP')
            .replace(/\{\{\s*country\s*\}\}/g, 'Brasil')
            .replace(/\{\{\s*start_date\s*\}\}/g, '15/03/2024')
            .replace(/\{\{\s*end_date\s*\}\}/g, '16/03/2024')
            .replace(/\{\{\s*emitted_at\s*\}\}/g, '17/03/2024')
            .replace(/\{\{\s*user\s*\}\}/g, 'Organizador do Evento');

        certificatePreview.innerHTML = exampleContent;
        certificatePreview.style.width = width + 'px';
        certificatePreview.style.height = height + 'px';
        previewContainer.classList.remove('hidden');
        
        // Scroll para o preview
        previewContainer.scrollIntoView({ behavior: 'smooth' });
    });

    // Resetar para template base
    resetBtn.addEventListener('click', function() {
        if (confirm('Deseja resetar para o template base? Suas altera√ß√µes ser√£o perdidas.')) {
            const baseHTML = `<div class="certificate-template bg-white border-4 border-yellow-400 p-12 text-center relative" style="min-height: 600px;">
    <div class="relative z-10 h-full flex flex-col justify-center items-center">
        <h1 class="text-4xl font-bold text-gray-800 mb-6">Certificado de Participa√ß√£o</h1>
        
        <div class="text-lg text-gray-700 leading-relaxed mb-8">
            <p>Certificamos que <strong>{{ first_name }} {{ last_name }}</strong> participou do evento</p>
            <p class="text-2xl font-bold text-blue-600 my-4">{{ name }}</p>
            <p>realizado em {{ city }}, {{ state }} - {{ country }}</p>
            <p>no per√≠odo de {{ start_date }} a {{ end_date }}</p>
        </div>
        
        <div class="mt-12 grid grid-cols-2 gap-8 w-full max-w-2xl">
            <div class="text-center">
                <div class="border-t-2 border-gray-400 mt-12 pt-4">
                    <p class="font-bold">Organizador do Evento</p>
                    <p class="text-gray-600">{{ user }}</p>
                </div>
            </div>
            <div class="text-center">
                <div class="border-t-2 border-gray-400 mt-12 pt-4">
                    <p class="font-bold">Data de Emiss√£o</p>
                    <p class="text-gray-600">{{ emitted_at }}</p>
                </div>
            </div>
        </div>
    </div>
</div>`;
            
            htmlContent.value = baseHTML;
        }
    });

    // Valida√ß√£o do formul√°rio
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        if (!htmlContent.value.trim()) {
            e.preventDefault();
            alert('O conte√∫do HTML do certificado √© obrigat√≥rio.');
            htmlContent.focus();
            return false;
        }
        
        // Verificar se h√° tags b√°sicas
        const content = htmlContent.value;
        if (!content.includes('{{ first_name }}') || !content.includes('{{ last_name }}')) {
            if (!confirm('Seu template n√£o cont√©m as tags para nome do aluno (first_name, last_name). Deseja continuar?')) {
                e.preventDefault();
                return false;
            }
        }
    });
});
</script>
{% endblock %}